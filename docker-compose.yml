name: opws

services:
  db:
    image: postgres:16-alpine
    container_name: opws_db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: opw
      POSTGRES_USER: opw_user
      POSTGRES_PASSWORD: "Linito_26O"
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U opw_user -d opw"]
      interval: 5s
      timeout: 5s
      retries: 10

  api:
    build:
      context: ./backend
    container_name: opws_api
    environment:
      # DB / API
      DATABASE_URL: "postgresql://opw_user:Linito_26O@db:5432/opw?schema=opws"
      PORT: "2002"

      # JWT
      JWT_SECRET: "TEQfGJmAH2ZwP9Y1HjP9QaqfYW7Aq/p49CuafGOhzCxFgDPCZOjg8xPblRNsCqnug9y0+xakCsv48ZDtcPul5w=="
      JWT_EXPIRES_IN: "8h"

      # EMAIL (Gmail real)
      MAIL_FROM: "OPWS <linozuleta26@gmail.com>"
      MAIL_DEV_LOG_ONLY: "false"
      SMTP_HOST: "smtp.gmail.com"
      SMTP_PORT: "587"
      SMTP_SECURE: "false"
      SMTP_USER: "linozuleta26@gmail.com"
      SMTP_PASS: "hafbkhgatpvjjxsv"

      # (opcional) URL p√∫blica usada en el link del correo
      APP_PUBLIC_URL: "http://localhost:2002"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:2002/api/health"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped
    # No exponemos puerto; el proxy del 'web' le pega como http://api:2002

  web:
    build:
      context: ./opws-web
      args:
        VITE_API_URL: "/api"  # el front llama a /api y el Nginx del 'web' debe proxy-pasear a http://api:2002
    container_name: opws_web
    ports:
      - "2002:80"   # app en http://localhost:2002
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

volumes:
  db_data:
