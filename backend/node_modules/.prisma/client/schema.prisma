generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * EXISTENTES (tus modelos)
 * =========================
 */

model Estacion {
  id     Int     @id @default(autoincrement())
  codigo String? @unique
  nombre String
  activo Boolean @default(true)

  latitud     Decimal? @db.Decimal(9, 6)
  longitud    Decimal? @db.Decimal(9, 6)
  elevacion_m Decimal? @db.Decimal(7, 2)

  zonaHoraria   String        @default("UTC") @map("zona_horaria")
  notas         String?
  creadoEn      DateTime      @default(now()) @map("creado_en")
  actualizadoEn DateTime      @default(now()) @map("actualizado_en")
  mediciones    Medicion[]
  dispositivos  Dispositivo[]

  @@index([activo])
  @@map("estaciones")
}

model TipoMedicion {
  id            Int               @id @default(autoincrement())
  clave         String            @unique // ej: air_temp, air_humidity, soil_moisture, luminosity, rain
  nombrePublico String?           @map("nombre_publico")
  unidad        String // ej: °C, %RH, %, lux, mm
  tipoAgregado  String            @map("tipo_agregado") // 'suma' | 'promedio'
  descripcion   String?
  mediciones    Medicion[]
  dispTipos     DispositivoTipo[]

  @@map("tipos_medicion")
}

model Medicion {
  id          BigInt   @id @default(autoincrement())
  estacionId  Int      @map("estacion_id")
  tipoId      Int      @map("tipo_id")
  instante    DateTime
  valor       Float
  crudo       Json?
  insertadoEn DateTime @default(now()) @map("insertado_en")

  estacion Estacion     @relation(fields: [estacionId], references: [id], onDelete: Cascade)
  tipo     TipoMedicion @relation(fields: [tipoId], references: [id], onDelete: Restrict)

  @@unique([estacionId, tipoId, instante], name: "uq_medicion")
  @@index([estacionId, tipoId, instante], name: "idx_med_est_tipo_ts")
  @@index([instante], name: "idx_med_ts")
  @@map("mediciones")
}

/**
 * =========================
 * NUEVOS (TTN / dispositivos)
 * =========================
 */

model Dispositivo {
  id            Int      @id @default(autoincrement())
  estacionId    Int      @map("estacion_id")
  devEui        String   @unique @map("dev_eui") // EUI del end device en TTN
  descripcion   String?
  activo        Boolean  @default(true)
  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  estacion Estacion          @relation(fields: [estacionId], references: [id], onDelete: Cascade)
  tipos    DispositivoTipo[]

  @@index([estacionId])
  @@index([activo])
  @@map("dispositivos")
}

model DispositivoTipo {
  dispositivoId Int      @map("dispositivo_id")
  tipoId        Int      @map("tipo_id")
  payloadKey    String   @map("payload_key") // clave en decoded_payload (ej: "air_temp")
  canal         Int? // opcional: índice de canal si aplica
  escala        Float?   @default(1.0) // multiplicador para convertir a unidad final
  offset        Float?   @default(0.0) // ajuste aditivo
  creadoEn      DateTime @default(now()) @map("creado_en")

  dispositivo Dispositivo  @relation(fields: [dispositivoId], references: [id], onDelete: Cascade)
  tipo        TipoMedicion @relation(fields: [tipoId], references: [id], onDelete: Cascade)

  @@id([dispositivoId, tipoId])
  @@unique([dispositivoId, payloadKey], name: "uq_disp_payload_key")
  @@index([tipoId])
  @@index([payloadKey])
  @@map("dispositivo_tipos")
}

/**
 * =========================
 * NUEVOS (auth y permisos)
 * =========================
 */

model Usuario {
  id Int @id @default(autoincrement())

  // Identidad
  username String? @unique
  email    String  @unique
  nombre   String?
  apellido String?

  // Autenticación
  password           String
  mustChangePassword Boolean   @default(true) @map("must_change_password")
  emailVerificadoEn  DateTime? @map("email_verificado_en")
  intentosFallidos   Int       @default(0) @map("intentos_fallidos")
  ultimoInicioEn     DateTime? @map("ultimo_inicio_en")

  // Estado/rol
  activo Boolean @default(true)
  rolId  Int?
  rol    Rol?    @relation(fields: [rolId], references: [id], onDelete: SetNull)

  // Rel.
  permisos UsuarioPermiso[]
  tokens   Token[]

  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  @@index([activo])
  @@index([rolId])
  @@map("usuarios")
}

model Rol {
  id       Int          @id @default(autoincrement())
  nombre   String       @unique // valores esperados: 'ADMIN', 'VIEWER'
  permisos RolPermiso[]
  usuarios Usuario[]

  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  @@map("roles")
}

model Permiso {
  id          Int              @id @default(autoincrement())
  nombre      String           @unique
  descripcion String?
  usuarios    UsuarioPermiso[]
  roles       RolPermiso[]

  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  @@map("permisos")
}

model UsuarioPermiso {
  usuarioId Int @map("usuario_id")
  permisoId Int @map("permiso_id")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  creadoEn DateTime @default(now()) @map("creado_en")

  @@id([usuarioId, permisoId])
  @@index([permisoId])
  @@map("usuario_permisos")
}

model RolPermiso {
  rolId     Int @map("rol_id")
  permisoId Int @map("permiso_id")

  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  creadoEn DateTime @default(now()) @map("creado_en")

  @@id([rolId, permisoId])
  @@index([permisoId])
  @@map("rol_permisos")
}

/**
 * =========================
 * NUEVO (tokens de email)
 * =========================
 */

enum TokenTipo {
  EMAIL_VERIFICACION
  PASSWORD_RESET
}

model Token {
  id        Int       @id @default(autoincrement())
  tipo      TokenTipo
  token     String    @unique
  usuarioId Int       @map("usuario_id")
  usuario   Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  expiraEn  DateTime  @map("expira_en")
  usadoEn   DateTime? @map("usado_en")
  creadoEn  DateTime  @default(now()) @map("creado_en")

  @@index([usuarioId])
  @@map("tokens")
}
