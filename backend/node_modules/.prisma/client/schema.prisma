generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * EXISTENTES (tus modelos)
 * =========================
 */

model Estacion {
  id     Int     @id @default(autoincrement())
  codigo String? @unique
  nombre String
  activo Boolean @default(true)

  latitud     Decimal? @db.Decimal(9, 6)
  longitud    Decimal? @db.Decimal(9, 6)
  elevacion_m Decimal? @db.Decimal(7, 2)

  zonaHoraria   String     @default("UTC") @map("zona_horaria")
  notas         String?
  creadoEn      DateTime   @default(now()) @map("creado_en")
  actualizadoEn DateTime   @default(now()) @map("actualizado_en")
  mediciones    Medicion[]

  @@index([activo])
  @@map("estaciones")
}

model TipoMedicion {
  id            Int        @id @default(autoincrement())
  clave         String     @unique
  nombrePublico String?    @map("nombre_publico")
  unidad        String
  tipoAgregado  String     @map("tipo_agregado") // 'suma' | 'promedio'
  descripcion   String?
  mediciones    Medicion[]

  @@map("tipos_medicion")
}

model Medicion {
  id          BigInt   @id @default(autoincrement())
  estacionId  Int      @map("estacion_id")
  tipoId      Int      @map("tipo_id")
  instante    DateTime
  valor       Float
  crudo       Json?
  insertadoEn DateTime @default(now()) @map("insertado_en")

  estacion Estacion     @relation(fields: [estacionId], references: [id], onDelete: Cascade)
  tipo     TipoMedicion @relation(fields: [tipoId], references: [id], onDelete: Restrict)

  @@unique([estacionId, tipoId, instante], name: "uq_medicion")
  @@index([estacionId, tipoId, instante], name: "idx_med_est_tipo_ts")
  @@index([instante], name: "idx_med_ts")
  @@map("mediciones")
}

/**
 * =========================
 * NUEVOS (auth y permisos)
 * =========================
 */

model Usuario {
  id Int @id @default(autoincrement())

  // Identidad
  username String? @unique // nuevo: login por usuario (único)
  email    String  @unique
  nombre   String? // ya estaba: nombre
  apellido String? // nuevo: apellido

  // Autenticación
  password           String // almacena el hash
  mustChangePassword Boolean   @default(true) @map("must_change_password") // obliga cambio al 1er login
  emailVerificadoEn  DateTime? @map("email_verificado_en")
  intentosFallidos   Int       @default(0) @map("intentos_fallidos")
  ultimoInicioEn     DateTime? @map("ultimo_inicio_en")

  // Estado/rol
  activo Boolean @default(true)
  rolId  Int?
  rol    Rol?    @relation(fields: [rolId], references: [id], onDelete: SetNull)

  // Rel.
  permisos UsuarioPermiso[]
  tokens   Token[]

  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  @@index([activo])
  @@index([rolId])
  @@map("usuarios")
}

model Rol {
  id       Int          @id @default(autoincrement())
  nombre   String       @unique // valores esperados: 'ADMIN', 'VIEWER'
  permisos RolPermiso[]
  usuarios Usuario[]

  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  @@map("roles")
}

model Permiso {
  id          Int              @id @default(autoincrement())
  nombre      String           @unique
  descripcion String?
  usuarios    UsuarioPermiso[]
  roles       RolPermiso[]

  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @default(now()) @map("actualizado_en")

  @@map("permisos")
}

model UsuarioPermiso {
  usuarioId Int @map("usuario_id")
  permisoId Int @map("permiso_id")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  creadoEn DateTime @default(now()) @map("creado_en")

  @@id([usuarioId, permisoId])
  @@index([permisoId])
  @@map("usuario_permisos")
}

model RolPermiso {
  rolId     Int @map("rol_id")
  permisoId Int @map("permiso_id")

  rol     Rol     @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  creadoEn DateTime @default(now()) @map("creado_en")

  @@id([rolId, permisoId])
  @@index([permisoId])
  @@map("rol_permisos")
}

/**
 * =========================
 * NUEVO (tokens de email)
 * =========================
 */

enum TokenTipo {
  EMAIL_VERIFICACION
  PASSWORD_RESET
}

model Token {
  id        Int       @id @default(autoincrement())
  tipo      TokenTipo
  token     String    @unique
  usuarioId Int       @map("usuario_id")
  usuario   Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  expiraEn  DateTime  @map("expira_en")
  usadoEn   DateTime? @map("usado_en")
  creadoEn  DateTime  @default(now()) @map("creado_en")

  @@index([usuarioId])
  @@map("tokens")
}
