generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opws"]  // ðŸ‘ˆ AGREGADO
}

/* =========================
   EXISTENTES (tus modelos)
========================= */

model Estacion {
  @@map("estaciones")
  id Int @id @default(autoincrement())
  codigo String? @unique
  nombre String
  activo Boolean @default(true)

  latitud Decimal? @db.Decimal(9, 6)
  longitud Decimal? @db.Decimal(9, 6)
  elevacion_m Decimal? @db.Decimal(7, 2)

  zonaHoraria String @map("zona_horaria") @default("UTC")
  notas String?
  creadoEn DateTime @map("creado_en") @default(now())
  actualizadoEn DateTime @map("actualizado_en") @default(now())
  mediciones Medicion[]
  dispositivos Dispositivo[]

  @@index([activo])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model TipoMedicion {
  @@map("tipos_medicion")
  id Int @id @default(autoincrement())
  clave String @unique
  nombrePublico String? @map("nombre_publico")
  unidad String
  tipoAgregado String @map("tipo_agregado")
  descripcion String?
  mediciones Medicion[]
  dispTipos DispositivoTipo[]

  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model Medicion {
  @@map("mediciones")
  id BigInt @id @default(autoincrement())
  estacionId Int @map("estacion_id")
  tipoId Int @map("tipo_id")
  instante DateTime
  valor Float
  crudo Json?
  insertadoEn DateTime @map("insertado_en") @default(now())

  estacion Estacion @relation(fields: [estacionId], references: [id], onDelete: Cascade)
  tipo TipoMedicion @relation(fields: [tipoId], references: [id], onDelete: Restrict)

  @@unique([estacionId, tipoId, instante], name: "uq_medicion")
  @@index([estacionId, tipoId, instante], name: "idx_med_est_tipo_ts")
  @@index([instante], name: "idx_med_ts")
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

/* =========================
   NUEVOS (TTN / dispositivos)
========================= */

model Dispositivo {
  @@map("dispositivos")
  id Int @id @default(autoincrement())
  estacionId Int @map("estacion_id")
  devEui String @map("dev_eui") @unique
  descripcion String?
  activo Boolean @default(true)
  creadoEn DateTime @map("creado_en") @default(now())
  actualizadoEn DateTime @map("actualizado_en") @default(now())

  estacion Estacion @relation(fields: [estacionId], references: [id], onDelete: Cascade)
  tipos DispositivoTipo[]

  @@index([estacionId])
  @@index([activo])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model DispositivoTipo {
  @@map("dispositivo_tipos")
  dispositivoId Int @map("dispositivo_id")
  tipoId Int @map("tipo_id")
  payloadKey String @map("payload_key")
  canal Int?
  escala Float? @default(1.0)
  offset Float? @default(0.0)
  creadoEn DateTime @map("creado_en") @default(now())

  dispositivo Dispositivo @relation(fields: [dispositivoId], references: [id], onDelete: Cascade)
  tipo TipoMedicion @relation(fields: [tipoId], references: [id], onDelete: Cascade)

  @@id([dispositivoId, tipoId])
  @@unique([dispositivoId, payloadKey], name: "uq_disp_payload_key")
  @@index([tipoId])
  @@index([payloadKey])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

/* =========================
   NUEVOS (auth y permisos)
========================= */

model Usuario {
  @@map("usuarios")
  id Int @id @default(autoincrement())

  username String? @unique
  email String @unique
  nombre String?
  apellido String?

  password String
  mustChangePassword Boolean @map("must_change_password") @default(true)
  emailVerificadoEn DateTime? @map("email_verificado_en")
  intentosFallidos Int @map("intentos_fallidos") @default(0)
  ultimoInicioEn DateTime? @map("ultimo_inicio_en")

  activo Boolean @default(true)
  rolId Int?
  rol Rol? @relation(fields: [rolId], references: [id], onDelete: SetNull)

  permisos UsuarioPermiso[]
  tokens Token[]

  creadoEn DateTime @map("creado_en") @default(now())
  actualizadoEn DateTime @map("actualizado_en") @default(now())

  @@index([activo])
  @@index([rolId])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model Rol {
  @@map("roles")
  id Int @id @default(autoincrement())
  nombre String @unique
  permisos RolPermiso[]
  usuarios Usuario[]

  creadoEn DateTime @map("creado_en") @default(now())
  actualizadoEn DateTime @map("actualizado_en") @default(now())

  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model Permiso {
  @@map("permisos")
  id Int @id @default(autoincrement())
  nombre String @unique
  descripcion String?
  usuarios UsuarioPermiso[]
  roles RolPermiso[]

  creadoEn DateTime @map("creado_en") @default(now())
  actualizadoEn DateTime @map("actualizado_en") @default(now())

  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model UsuarioPermiso {
  @@map("usuario_permisos")
  usuarioId Int @map("usuario_id")
  permisoId Int @map("permiso_id")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  creadoEn DateTime @map("creado_en") @default(now())

  @@id([usuarioId, permisoId])
  @@index([permisoId])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

model RolPermiso {
  @@map("rol_permisos")
  rolId Int @map("rol_id")
  permisoId Int @map("permiso_id")

  rol Rol @relation(fields: [rolId], references: [id], onDelete: Cascade)
  permiso Permiso @relation(fields: [permisoId], references: [id], onDelete: Cascade)

  creadoEn DateTime @map("creado_en") @default(now())

  @@id([rolId, permisoId])
  @@index([permisoId])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}

/* =========================
   NUEVO (tokens de email)
========================= */

enum TokenTipo {
  EMAIL_VERIFICACION
  PASSWORD_RESET

  @@schema("opws")  // ðŸ‘ˆ AGREGADO (para el enum tambiÃ©n)
}

model Token {
  @@map("tokens")
  id Int @id @default(autoincrement())
  tipo TokenTipo
  token String @unique
  usuarioId Int @map("usuario_id")
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  expiraEn DateTime @map("expira_en")
  usadoEn DateTime? @map("usado_en")
  creadoEn DateTime @map("creado_en") @default(now())

  @@index([usuarioId])
  @@schema("opws")  // ðŸ‘ˆ AGREGADO
}